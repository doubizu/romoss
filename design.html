<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>罗曼订制页面</title>
		<link rel="stylesheet" type="text/css" href="css/weui.min.css" />
		<link rel="stylesheet" type="text/css" href="css/common.css"/>
		<link rel="stylesheet" type="text/css" href="css/design.css"/>
		<link rel="stylesheet" type="text/css" href="font/font.css"/>
	</head>
	<body>
		<!-- 设计主面版  -->
		<div class="page design">
			<div class="navbar">
				<span class="head">
					<a href="javascript:;">
						<i class="icon-left"></i>
					</a>
				</span>
				<span class="body">
					个性化定制
				</span>
				<span class="footer">
					
				</span>
			</div>
			<div class="content">
				<div class="left">
					<canvas id="polymos" class="polymos" width="1000px" height="1000px"></canvas>
				</div>
				<div class="right">
					<div class="item" id="image">
						<img src="img/design/moto2.png" />
						<p>选图</p>
					</div>
					<div class="item" id="upfileimg">
						<img src="img/design/upload2.png" />
						<p>上传</p>
					</div>
					<div class="item" id="text">
						<img src="img/design/font2.png" />
						<p>文字</p>
					</div>
					<div class="item" id="zoom">
						<img src="img/design/zoom2.png" />
						<p>缩放</p>
					</div>
					<div class="item" id="rotation">
						<img src="img/design/rotate2.png" />
						<p>旋转</p>
					</div>
					<div class="item" id="delete">
						<img src="img/design/del2.png" />
						<p>删除</p>
					</div>
					<div class="item" id="mydesign">
						<img src="img/design/works2.png" />
						<p>作品</p>
					</div>
					<div class="item" id="save">
						<img src="img/design/save1.png"/>
						<p>保存</p>
					</div>
				</div>
				
				<input type="file" id="upfile" style="display:none;"/>
			</div>
			<div class="toolbar">
				<div class="weui_navbar">
					<div class="weui_navbar_item" id="make">
						<img src="img/design/gooddesing.png" />&nbsp;商品详情
					</div>
					<div class="weui_navbar_item" id="preview">
						<img src="img/design/preview.png" />&nbsp;预览设计
					</div>
					<div class="weui_navbar_item weui_bar_item_on" id="shopcar">
						<img src="img/design/shopcar11.png" />&nbsp;加入购物车
					</div>
				</div>
			</div>
		</div>
		
		<!-- 预览设计页面 -->
		<div class="page preview" style="display: none;">
			<div class="navbar makenav">
				<span class="head">
					<a href="javascript:;">
						<i class="icon-left"></i>
					</a>
				</span>
				<span class="body">
					我的定制预览
				</span>
				<span class="footer">
				</span>
			</div>
			<div class="content">
				<img id="preview_img" src=""/>
			</div>
			<div class="toolbar">
				<div class="weui_navbar">
					<div class="weui_navbar_item">
						<a href="javascript:;" id = "pre_save">
							<img src="img/MyPreview/save1 (2).png" />&nbsp;保存设计
						</a>
					</div>
					<div class="weui_navbar_item weui_bar_item_on">
						<a href="javascript:;" id = "pre_shopcar">
							<img src="img/MyPreview/shopcar11.png" />&nbsp;加入购物车
						</a>
					</div>
				</div>
			</div>
		</div>
		
		<!-- 协议弹窗 -->
		<div class="weui_dialog_confirm Customprotocol" id="warning">
			<div class="weui_mask"></div>
			<div class="weui_dialog">
				<div class="weui_dialog_hd Customprotocol-title"><strong class="weui_dialog_title">定制协议</strong></div>
				<div class="weui_dialog_bd Customprotocol-content">
					<h4> 声明：您明白、确认并且同意，您提交的用于定制的照片（图片）内容必须符合中华人民共和国适用法律的规定，不得侵犯任何第三方的任何权利，一旦违规产生的不良后果将由您自己承担！您的任何侵权行为与本公司没有任何关系，如果因此给本公司造成损失的应负责赔偿。最终解释权归罗马仕所有。
		        	</h4>
					<ol>上传图片要求：
						<li>图片素材仅限JPG格式；</li>
						<li>为保证印刷效果，建议图片不小于2M哦；</li>
						<li>您还可以联系客服，审核您要上传的图片；</li>
					</ol>
		        </div>
		        <div class="Customprotocol-footer">
		        	<a href="javascript:;"  class="Custom-footer-a">取消</a>
		            <a href="javascript:;"  class="Custom-footer-a Custom-footer-on">同意</a>
		        </div>
		      </div>
		</div>
		
		<!-- 文字输入弹窗 -->
		<div class="weui_dialog_confirm" id="confirm_dialog" style="display: none;">
		    <div class="weui_mask"></div>
		    <div class="weui_dialog">
		        <div class="weui_dialog_hd"><strong class="weui_dialog_title">请输入文字</strong></div>
		        <div class="weui_dialog_bd">
		        	<textarea class="weui_textarea" placeholder="请输入文字" rows="3"></textarea>
		        </div>
		        <div class="weui_dialog_ft">
		            <a href="javascript:;" class="weui_btn_dialog default">取消</a>
		            <a href="javascript:;" class="weui_btn_dialog primary">确定</a>
		        </div>
		    </div>
		</div>
		
		<!-- 保存成功提示 -->
		<div class="weui_dialog_alert" id="saveDialog" style="display: none;">
		    <div class="weui_mask"></div>
		    <div class="weui_dialog">
		        <div class="weui_dialog_hd"><strong class="weui_dialog_title">保存成功</strong></div>
		        <div class="weui_dialog_bd">恭喜您，您的设计保存成功，点击作品进行查看!</div>
		        <div class="weui_dialog_ft">
		            <a href="javascript:;" class="weui_btn_dialog primary">确定</a>
		        </div>
		    </div>
		</div>
		
		<!-- 过渡条 -->
		<div id="loadingToast" class="weui_loading_toast" style="display: none;">
		    <div class="weui_mask_transparent"></div>
		    <div class="weui_toast">
		        <div class="weui_loading">
		            <div class="weui_loading_leaf weui_loading_leaf_0"></div>
		            <div class="weui_loading_leaf weui_loading_leaf_1"></div>
		            <div class="weui_loading_leaf weui_loading_leaf_2"></div>
		            <div class="weui_loading_leaf weui_loading_leaf_3"></div>
		            <div class="weui_loading_leaf weui_loading_leaf_4"></div>
		            <div class="weui_loading_leaf weui_loading_leaf_5"></div>
		            <div class="weui_loading_leaf weui_loading_leaf_6"></div>
		            <div class="weui_loading_leaf weui_loading_leaf_7"></div>
		            <div class="weui_loading_leaf weui_loading_leaf_8"></div>
		            <div class="weui_loading_leaf weui_loading_leaf_9"></div>
		            <div class="weui_loading_leaf weui_loading_leaf_10"></div>
		            <div class="weui_loading_leaf weui_loading_leaf_11"></div>
		        </div>
		        <p class="weui_toast_content">数据加载中</p>
		    </div>
		</div>
		
		<!-- 上拉框 -->
		<div id="actionSheet_wrap">
		    <!--<div class="weui_mask_transition weui_fade_toggle" id="mask" style="display: block;"></div>-->
		    <div class="weui_actionsheet" id="weui_actionsheet">
		        <div class="weui_actionsheet_menu">
		        </div>
		        <div class="weui_actionsheet_action">
		            <div class="weui_actionsheet_cell" id="actionsheet_cancel">取消</div>
		        </div>
		    </div>
		</div>
		
		<!-- 精选美图模板 -->
		<script type="text/html" id="tmp_image">
			<div class="weui_tab">
		        <div class="weui_navbar">
		            <div class="weui_navbar_item weui_bar_item_on" data-index="0">
		            	图片分类
		            </div>
		            <div class="weui_navbar_item" data-index="1">
		            	图片分类
		            </div>
		            <div class="weui_navbar_item" data-index="2">
		            	图片分类
		            </div>
		        </div>
		        <div class="weui_tab_bd">
					<ul class="imgset">
						<li><img src="img/png/1.png"/></li>
						<li><img src="img/png/2.png"/></li>
						<li><img src="img/png/3.png"/></li>
						<li><img src="img/png/4.png"/></li>
						<li><img src="img/png/5.png"/></li>
						<li><img src="img/png/6.png"/></li>
						<li><img src="img/png/7.png"/></li>
						<li><img src="img/png/8.png"/></li>
						<li><img src="img/png/9.png"/></li>
					</ul>
					
					<ul class="imgset" style="display: none;">
						<li><img src="img/png/1.png"/></li>
						<li><img src="img/png/2.png"/></li>
						<li><img src="img/png/3.png"/></li>
						<li><img src="img/png/4.png"/></li>
						<li><img src="img/png/5.png"/></li>
						<li><img src="img/png/6.png"/></li>
						<li><img src="img/png/7.png"/></li>
						<li><img src="img/png/8.png"/></li>
						<li><img src="img/png/9.png"/></li>
					</ul>
					
					<ul class="imgset" style="display: none;">
						<li><img src="img/png/1.png"/></li>
						<li><img src="img/png/2.png"/></li>
						<li><img src="img/png/3.png"/></li>
						<li><img src="img/png/4.png"/></li>
						<li><img src="img/png/5.png"/></li>
						<li><img src="img/png/6.png"/></li>
						<li><img src="img/png/7.png"/></li>
						<li><img src="img/png/8.png"/></li>
						<li><img src="img/png/9.png"/></li>
					</ul>
		        </div>
		    </div>
		</script>
		
		<!-- 绽放、旋转模板 -->
		<script type="text/html" id="tmp_zoom">
			<div class="zoom">
				<div class="dragdealer" id="dragdealer">
		            <div class="handle blue-bar">
		            	<span class="value"></span>
		            </div>
		       </div>		
			</div>
		</script>
		
		<!-- 文字设置模板 -->
		<script type="text/html" id="tmp_textset">
			<div class="weui_cells">
		        <div class="weui_cell weui_cell_select weui_select_after">
		            <div class="weui_cell_hd">
		                <label for="" class="weui_label">颜色</label>
		            </div>
		            <div class="weui_cell_bd weui_cell_primary">
		                <select class="weui_select colorselect">
		                	<option>Black</option>
		                	<option>White</option>
		                	<option>Red</option>
		                	<option>Yellow</option>
		                	<option>Lime</option>
		                	<option>Aqua</option>
		                	<option>Blue</option>
		                	<option>Fuchsia</option>
		                	<option>Gray</option>
		                	<option>Silver</option>
		                	<option>Maroon</option>
		                	<option>Olive</option>
		                	<option>Green</option>
		                	<option>Teal</option>
		                	<option>Navy</option>
		                	<option>Purple</option>
		                	<option>aliceblue</option>
		                	<option>antiquewhite</option>
		                </select>
		            </div>
		        </div>
		        
		        <div class="weui_cell weui_cell_select weui_select_after">
		            <div class="weui_cell_hd">
		                <label for="" class="weui_label">字体</label>
		            </div>
		            <div class="weui_cell_bd weui_cell_primary">
		                <select class="weui_select fontselect">
		                	<option value="Arial">默认</option>
		                	<option>悦变</option>
		                	<option>毛笔行书</option>
		                	<option>古韵</option>
		                	<option>行楷</option>
		                	<option>硬笔行书</option>
		                	<option>几何体</option>
		                	<option>丛台体</option>
		                	<option>炫丽体</option>
		                	<option>刀锋黑草</option>
		                	<option>萝卜体</option>
		                </select>
		            </div>
		        </div>
		    </div>
        </div>
		</script>
	</body>
	<script src="js/jquery-1.10.2.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/easeljs-0.8.2.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/jquery.touchSwipe.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/dragdealer.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/draw.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
	var actionsheet = cancel = curdraw = confirmDialog = saveDialog = null;
	
	$(function(){
		actionsheet = $("#weui_actionsheet"); //上拉窗口
		cancel = $("#actionsheet_cancel"); //退出上窗口
		confirmDialog = $("#confirm_dialog"); //文字弹窗
		saveDialog = $("#saveDialog"); //保存成功
		curdraw = new Draw("polymos");
		
		//隐藏协议弹窗
		$("#warning .Custom-footer-a").swipe({
			tap : function() {
				$("#warning").hide();
			}
		});
		
		//响应设计窗图文切换
		curdraw.onchange(function(){
			if( curdraw.current.name.indexOf("text") != -1 ) {
				actionsheet.find(".weui_actionsheet_menu").html($("#tmp_textset").html());
				hideActionSheet().then(function(){
					actionsheet.addClass("weui_actionsheet_toggle");
					actionsheet.find(".colorselect").change(function(){
						curdraw.setColor($(this).val());
					});
					actionsheet.find(".fontselect").change(function(){
						curdraw.setFamily($(this).val());
					});
				});
			} else if ( curdraw.current.name.indexOf("bitmap") != -1 ) {
				hideActionSheet();
			}
		});
		
		//精选美图
		$("#image").swipe({
			tap : function() {
				actionsheet.find(".weui_actionsheet_menu").html($("#tmp_image").html());
				hideActionSheet().then(function(){
					actionsheet.addClass("weui_actionsheet_toggle");//显示上拉
					
					//绑订图片事件
					$(".imgset li img").unbind().swipe({
						tap : function() {
							loadImg($(this).attr("src")).then(function( img ){
								curdraw.addBitmap(img);
			                    hideActionSheet();
							});
						}
					});
					
					//绑订切换
					$(".weui_tab .weui_navbar .weui_navbar_item").unbind().swipe({
						tap :function() {
							var index = $(this).data("index");
							$(this).addClass("weui_bar_item_on").siblings(".weui_navbar_item")
								   .removeClass("weui_bar_item_on");
							$(".weui_tab .weui_tab_bd .imgset").eq(index).show().siblings(".imgset")
								   .hide();
						}
					});
				});
			}
		});
		
		//上传图片
		$("#upfileimg").swipe({
			tap : function() {
				hideActionSheet();
				$("#upfile").unbind().change(function() {
                    var file = this.files[0];
                    //检测输入
                    if( file.type == "image/png" || file.type == "image/jpg" || file.type == "image/jpeg" || file.type == "image/gif" ) {
                    	readFile( file ).then(function( img ){
	                    	curdraw.addBitmap(img);
	                    });
                    } else {
                    	alert("图片格式不正确!");
                    }
                });
                return $("#upfile").click();
			}
		});
		
		//设置文字
		$("#text").swipe({
			tap : function() {
				hideActionSheet();
				confirmDialog.show();
			}
		});
		
		//删除图形
		$("#delete").swipe({
			tap : function() {
				hideActionSheet();
				curdraw.delete();
			}
		});
		
		//保存设计
		$("#save,#pre_save").swipe({
			tap : function() {
				hideActionSheet();
				$("#loadingToast").show();
                curdraw.save().then(function( img ) {
                	//img 为base64格式
                    sessionStorage.setItem(new Date().getTime(),img);
                    $(".preview").hide();//预览页面隐藏
                    $(".design").show(); //设计页面显示
                    curdraw.clear();
                    $("#loadingToast").hide();
                    saveDialog.show();
                });
			}
		});
		
		//预览跳转页面
		$("#preview").swipe({
			tap : function() {
				hideActionSheet();
				$("#loadingToast").show();
                curdraw.save().then(function( img ) {
                    $("#preview_img").attr("src",img);
                    $(".preview").show();
                    $(".design").hide();
                    $("#loadingToast").hide();
                });
			}
		});
		
		//预览返回
		$(".preview .head a").swipe({
			tap : function() {
				$(".preview").hide();
                $(".design").show();
			}
		});
		
		//缩放
		$("#zoom").swipe({
			tap : function() {
				if( curdraw.current == null ) {
					return;
				}
				actionsheet.find(".weui_actionsheet_menu").html($("#tmp_zoom").html());
				//清除手机长按
				$("#dragdealer .blue-bar").get(0).ontouchstart = function(e) { e.preventDefault(); };
				hideActionSheet().then(function(){
					actionsheet.addClass("weui_actionsheet_toggle").css("background-color","transparent")
							   .find(".weui_actionsheet_menu").css("background-color","transparent");
					
					var multiple = 1;
					var width = curdraw.getScale().x;
					if( curdraw.current.name.indexOf("text") != -1 ) {
						multiple = 10; //文字扩大10位
					} else if( width >= 0.8 ) { //图片如小于0.8扩大3倍
						multiple = 3;
					}
					
					new Dragdealer('dragdealer', {
	        			x : width / multiple,
						animationCallback: function(x, y) {
						    $('#dragdealer .value').text(Math.round(x * 100)+"%");
						    curdraw.setScale( x * multiple,x * multiple );
						}
					});
				});
			}
		});
		
		//旋转
		$("#rotation").swipe({
			tap : function() {
				if( curdraw.current == null ) {
					return;
				}
				actionsheet.find(".weui_actionsheet_menu").html($("#tmp_zoom").html());
				//清除手机长按
				$("#dragdealer .blue-bar").get(0).ontouchstart = function(e) { e.preventDefault(); };
				hideActionSheet().then(function(){
					actionsheet.addClass("weui_actionsheet_toggle").css("background-color","transparent")
							   .find(".weui_actionsheet_menu").css("background-color","transparent");
					new Dragdealer('dragdealer', {
	        			x : curdraw.getRotation() / 360,
						animationCallback: function(x, y) {
						    $('#dragdealer .value').text(Math.round(x * 100) + "%");
						    curdraw.setRotation(x * 360);
						}
					});
				});
			}
		});
		
		//取消文字弹窗
		confirmDialog.find(".default").swipe({
			tap : function() {
				confirmDialog.find(".weui_textarea").val("");
				confirmDialog.hide();
			}
		});
		
		//确认文字弹窗
		confirmDialog.find(".primary").swipe({
			tap : function() {
				curdraw.addText(confirmDialog.find(".weui_textarea").val());
				confirmDialog.find(".weui_textarea").val("");
				confirmDialog.hide();
			}
		});
		
		//保存成功提示
		saveDialog.find(".primary").swipe({
			tap : function() {
				saveDialog.hide();
			}
		});
		
		//上拉退出按钮
		cancel.swipe({
			tap : function() {
				hideActionSheet();
			}
		});
		
		//我的作品
		$("#mydesign").swipe({
			tap : function() {
				window.location.href = "mydesign.html";
			}
		});
		
		//跳转详情
		$("#make").swipe({
			tap : function() {
				window.location.href = "make.html";
			}
		});
		
		//购物车
		$("#shopcar,#pre_shopcar").swipe({
			tap : function() {
				window.location.href = "shopcar.html";
			}
		});
	});
	
	function hideActionSheet() {
		var d = $.Deferred();
		
		isshow = true;
		actionsheet.removeClass("weui_actionsheet_toggle").css("background-color","")
				   .find(".weui_actionsheet_menu").css("background-color","");
		setTimeout(function(){
			d.resolve();
		},400);
		
		return d.promise();
	}
	
	function loadImg( src ) {
		$("#loadingToast").show();
		var d = $.Deferred();
		
		var img = new Image();
		img.src = src;
		img.onload = function() {
			d.resolve( img );
			$("#loadingToast").hide();
		}
		
		return d.promise();
	}
	
	function readFile( file ) {
		$("#loadingToast").show();
		var d = $.Deferred();
		
		var fr = new FileReader();
		fr.readAsDataURL( file );
		fr.onload = function() {
			var img = new Image();
            img.src = fr.result;
            img.onload = function() {
                d.resolve( img );
				$("#loadingToast").hide();
            }
		}
		
		return d.promise();
	}
	</script>
</html>